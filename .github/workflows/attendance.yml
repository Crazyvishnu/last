name: MGIT Attendance Bot

# run on schedule (8:00 AM IST and 4:00 PM IST) and allow manual trigger
on:
  schedule:
    # 8:00 AM IST = 02:30 UTC
    - cron: '30 2 * * *'
    # 4:00 PM IST = 10:30 UTC
    - cron: '30 10 * * *'
  workflow_dispatch:
    inputs:
      discover:
        description: 'Set to true to run discovery mode (DISCOVER=1)'
        required: false
        default: 'false'
      use_selenium:
        description: 'Set to true to enable Selenium in this run (USE_SELENIUM=1)'
        required: false
        default: 'false'

jobs:
  run-attendance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install system deps (Chromium + Chromedriver)
        run: |
          sudo apt-get update
          # install chromium-browser and chromedriver
          sudo apt-get install -y chromium-browser chromium-chromedriver
          # show versions for debugging
          chromium-browser --version || true
          chromedriver --version || true

      - name: Create venv & install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Show environment (debug)
        run: |
          echo "USE_SELENIUM input: ${{ github.event.inputs.use_selenium }}"
          echo "DISCOVER input: ${{ github.event.inputs.discover }}"
          python -V

      - name: Run attendance bot
        env:
          # Twilio & WhatsApp
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_WHATSAPP_FROM: ${{ secrets.TWILIO_WHATSAPP_FROM }}
          YOUR_WHATSAPP_NUMBER: ${{ secrets.YOUR_WHATSAPP_NUMBER }}

          # MGIT credentials
          MGIT_USERNAME: ${{ secrets.MGIT_USERNAME }}
          MGIT_PASSWORD: ${{ secrets.MGIT_PASSWORD }}

          # Optional developer debug
          DEV_WHATSAPP_NUMBER: ${{ secrets.DEV_WHATSAPP_NUMBER }}

          # Set USE_SELENIUM from input; set to '1' if input true
          USE_SELENIUM: ${{ contains(fromJson('["true","True","1","yes","y"]'), github.event.inputs.use_selenium) && '1' || '0' }}
          # Set DISCOVER from input; set to '1' if input true
          DISCOVER: ${{ contains(fromJson('["true","True","1","yes","y"]'), github.event.inputs.discover) && '1' || '0' }}
          BASE_URL: ${{ secrets.BASE_URL }}
        run: |
          # show which mode will run
          echo "USE_SELENIUM=$USE_SELENIUM"
          echo "DISCOVER=$DISCOVER"
          # run the script (it checks DISCOVER env var)
          python attendance_whatsapp.py
